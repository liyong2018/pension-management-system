<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.pension.dao.WatchDataRecordDao">

    <!-- 结果映射 -->
    <resultMap id="WatchDataRecordResultMap" type="com.example.pension.model.WatchDataRecord">
        <id column="id" property="id" />
        <result column="device_id" property="deviceId" />
        <result column="elderly_id" property="elderlyId" />
        <result column="heart_rate" property="heartRate" />
        <result column="systolic_pressure" property="systolicPressure" />
        <result column="diastolic_pressure" property="diastolicPressure" />
        <result column="blood_oxygen" property="bloodOxygen" />
        <result column="body_temperature" property="bodyTemperature" />
        <result column="steps" property="steps" />
        <result column="sleep_status" property="sleepStatus" />
        <result column="longitude" property="longitude" />
        <result column="latitude" property="latitude" />
        <result column="battery_level" property="batteryLevel" />
        <result column="charging" property="charging" />
        <result column="device_status" property="deviceStatus" />
        <result column="timestamp" property="timestamp" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        id, device_id, elderly_id, heart_rate, systolic_pressure, diastolic_pressure, blood_oxygen, 
        body_temperature, steps, sleep_status, longitude, latitude, battery_level, charging, 
        device_status, timestamp, create_time, update_time
    </sql>

    <!-- 插入记录 -->
    <insert id="insert" parameterType="com.example.pension.model.WatchDataRecord" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO watch_data_record (
            device_id, elderly_id, heart_rate, systolic_pressure, diastolic_pressure, blood_oxygen, 
            body_temperature, steps, sleep_status, longitude, latitude, battery_level, charging, 
            device_status, timestamp, create_time, update_time
        ) VALUES (
            #{deviceId}, #{elderlyId}, #{heartRate}, #{systolicPressure}, #{diastolicPressure}, #{bloodOxygen}, 
            #{bodyTemperature}, #{steps}, #{sleepStatus}, #{longitude}, #{latitude}, #{batteryLevel}, #{charging}, 
            #{deviceStatus}, #{timestamp}, NOW(), NOW()
        )
    </insert>

    <!-- 根据ID查询记录 -->
    <select id="findById" resultMap="WatchDataRecordResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM watch_data_record
        WHERE id = #{id}
    </select>

    <!-- 根据设备ID查询最新记录 -->
    <select id="findLatestByDeviceId" resultMap="WatchDataRecordResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM watch_data_record
        WHERE device_id = #{deviceId}
        ORDER BY timestamp DESC
        LIMIT 1
    </select>

    <!-- 根据老人ID查询最新记录 -->
    <select id="findLatestByElderlyId" resultMap="WatchDataRecordResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM watch_data_record
        WHERE elderly_id = #{elderlyId}
        ORDER BY timestamp DESC
        LIMIT 1
    </select>

    <!-- 根据设备ID查询记录列表 -->
    <select id="findByDeviceId" resultMap="WatchDataRecordResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM watch_data_record
        WHERE device_id = #{deviceId}
        ORDER BY timestamp DESC
        LIMIT #{limit}
    </select>

    <!-- 根据老人ID查询记录列表 -->
    <select id="findByElderlyId" resultMap="WatchDataRecordResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM watch_data_record
        WHERE elderly_id = #{elderlyId}
        ORDER BY timestamp DESC
        LIMIT #{limit}
    </select>

    <!-- 根据条件查询记录列表 -->
    <select id="findWithConditions" resultMap="WatchDataRecordResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM watch_data_record
        <where>
            <if test="deviceId != null and deviceId != ''">
                AND device_id = #{deviceId}
            </if>
            <if test="elderlyId != null">
                AND elderly_id = #{elderlyId}
            </if>
            <if test="startTime != null">
                AND timestamp &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND timestamp &lt;= #{endTime}
            </if>
        </where>
        ORDER BY timestamp DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 更新记录 -->
    <update id="update" parameterType="com.example.pension.model.WatchDataRecord">
        UPDATE watch_data_record
        <set>
            <if test="elderlyId != null">
                elderly_id = #{elderlyId},
            </if>
            <if test="heartRate != null">
                heart_rate = #{heartRate},
            </if>
            <if test="systolicPressure != null">
                systolic_pressure = #{systolicPressure},
            </if>
            <if test="diastolicPressure != null">
                diastolic_pressure = #{diastolicPressure},
            </if>
            <if test="bloodOxygen != null">
                blood_oxygen = #{bloodOxygen},
            </if>
            <if test="bodyTemperature != null">
                body_temperature = #{bodyTemperature},
            </if>
            <if test="steps != null">
                steps = #{steps},
            </if>
            <if test="sleepStatus != null">
                sleep_status = #{sleepStatus},
            </if>
            <if test="longitude != null">
                longitude = #{longitude},
            </if>
            <if test="latitude != null">
                latitude = #{latitude},
            </if>
            <if test="batteryLevel != null">
                battery_level = #{batteryLevel},
            </if>
            <if test="charging != null">
                charging = #{charging},
            </if>
            <if test="deviceStatus != null">
                device_status = #{deviceStatus},
            </if>
            <if test="timestamp != null">
                timestamp = #{timestamp},
            </if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除记录 -->
    <delete id="deleteById">
        DELETE FROM watch_data_record
        WHERE id = #{id}
    </delete>

</mapper>