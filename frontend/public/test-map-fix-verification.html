<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图功能修复验证</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .loading { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.active {
            background: #28a745;
        }
        .data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .map-container {
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card.blue { background: linear-gradient(135deg, #00d4ff 0%, #007bff 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); }
        .stat-card.green { background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%); }
        .stat-card.red { background: linear-gradient(135deg, #ff4757 0%, #dc3545 100%); }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .layer-btn {
            padding: 8px 16px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .layer-btn.active {
            background: #007bff;
            color: white;
        }
        .layer-btn:hover {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗺️ 地图功能修复验证</h1>
        <p>验证地址：<code>http://localhost:3004/test-map-fix-verification.html</code></p>
        
        <div class="card">
            <h2 class="title">1. 修复结果概览</h2>
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-value" id="communityCount">-</div>
                    <div class="stat-label">社区数量</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-value" id="organizationCount">-</div>
                    <div class="stat-label">机构数量</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-value" id="elderlyCount">-</div>
                    <div class="stat-label">老人数量</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-value" id="alarmCount">-</div>
                    <div class="stat-label">告警数量</div>
                </div>
            </div>
            <button class="btn" onclick="loadMapData()">🔄 刷新数据</button>
            <div id="dataStatus" class="status loading">等待加载数据...</div>
        </div>

        <div class="grid">
            <div class="card">
                <h2 class="title">2. 地图图层控制</h2>
                <div class="controls">
                    <button class="layer-btn active" id="communityBtn" onclick="toggleLayer('communities')">
                        🏘️ 社区 (<span id="communityBtnCount">0</span>)
                    </button>
                    <button class="layer-btn active" id="organizationBtn" onclick="toggleLayer('organizations')">
                        🏢 机构 (<span id="organizationBtnCount">0</span>)
                    </button>
                    <button class="layer-btn" id="elderlyBtn" onclick="toggleLayer('elderly')">
                        👥 老人 (<span id="elderlyBtnCount">0</span>)
                    </button>
                    <button class="layer-btn active" id="alarmBtn" onclick="toggleLayer('alarms')">
                        🚨 告警 (<span id="alarmBtnCount">0</span>)
                    </button>
                </div>
                <button class="btn" onclick="resetMapView()">🎯 重置视图</button>
                <button class="btn" onclick="showAllLayers()">👁️ 显示全部</button>
                <button class="btn" onclick="hideAllLayers()">🙈 隐藏全部</button>
            </div>

            <div class="card">
                <h2 class="title">3. 数据验证结果</h2>
                <div id="validationResults">
                    <div class="status loading">等待验证...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="title">4. 交互式地图</h2>
            <div id="mapContainer" class="map-container"></div>
        </div>

        <div class="card">
            <h2 class="title">5. 原始数据查看</h2>
            <button class="btn" onclick="showRawData()">📋 查看原始数据</button>
            <div id="rawData" class="data" style="display: none;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let mapInstance = null;
        let mapData = null;
        let mapLayers = {
            communities: null,
            organizations: null,
            elderly: null,
            alarms: null
        };
        let layerVisibility = {
            communities: true,
            organizations: true,
            elderly: false,
            alarms: true
        };

        // API基础URL
        const API_BASE = '/api';

        async function loadMapData() {
            const statusEl = document.getElementById('dataStatus');
            statusEl.className = 'status loading';
            statusEl.textContent = '正在加载地图数据...';

            try {
                const response = await fetch(`${API_BASE}/dashboard/stats`);
                const result = await response.json();

                if (result.success && result.data.mapData) {
                    mapData = result.data.mapData;
                    
                    // 更新统计数据
                    updateStats();
                    
                    // 验证数据
                    validateData();
                    
                    // 初始化地图
                    initMap();
                    
                    statusEl.className = 'status success';
                    statusEl.textContent = '✅ 地图数据加载成功！';
                } else {
                    throw new Error('地图数据为空或格式错误');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '❌ 地图数据加载失败: ' + error.message;
            }
        }

        function updateStats() {
            document.getElementById('communityCount').textContent = mapData.communities?.length || 0;
            document.getElementById('organizationCount').textContent = mapData.organizations?.length || 0;
            document.getElementById('elderlyCount').textContent = mapData.elderly?.length || 0;
            document.getElementById('alarmCount').textContent = mapData.alarms?.length || 0;
            
            // 更新按钮计数
            document.getElementById('communityBtnCount').textContent = mapData.communities?.length || 0;
            document.getElementById('organizationBtnCount').textContent = mapData.organizations?.length || 0;
            document.getElementById('elderlyBtnCount').textContent = mapData.elderly?.length || 0;
            document.getElementById('alarmBtnCount').textContent = mapData.alarms?.length || 0;
        }

        function validateData() {
            const resultsEl = document.getElementById('validationResults');
            const results = [];

            // 验证社区数据
            const communityCount = mapData.communities?.length || 0;
            if (communityCount >= 11) {
                results.push(`✅ 社区数据正确：${communityCount}个社区（≥11个）`);
            } else {
                results.push(`❌ 社区数据不足：${communityCount}个社区（应≥11个）`);
            }

            // 验证机构数据
            const organizationCount = mapData.organizations?.length || 0;
            if (organizationCount >= 3) {
                results.push(`✅ 机构数据正确：${organizationCount}个机构（≥3个）`);
            } else {
                results.push(`❌ 机构数据不足：${organizationCount}个机构（应≥3个）`);
            }

            // 验证老人数据
            const elderlyCount = mapData.elderly?.length || 0;
            if (elderlyCount > 0) {
                results.push(`✅ 老人数据存在：${elderlyCount}个老人记录`);
            } else {
                results.push(`⚠️ 老人数据为空：${elderlyCount}个老人记录`);
            }

            // 验证告警数据
            const alarmCount = mapData.alarms?.length || 0;
            if (alarmCount > 0) {
                results.push(`✅ 告警数据存在：${alarmCount}个告警记录`);
            } else {
                results.push(`⚠️ 告警数据为空：${alarmCount}个告警记录`);
            }

            // 验证坐标数据
            let validCoords = 0;
            let totalItems = 0;
            
            ['communities', 'organizations', 'elderly', 'alarms'].forEach(type => {
                if (mapData[type]) {
                    mapData[type].forEach(item => {
                        totalItems++;
                        if (item.longitude && item.latitude) {
                            validCoords++;
                        }
                    });
                }
            });

            if (validCoords === totalItems && totalItems > 0) {
                results.push(`✅ 坐标数据完整：${validCoords}/${totalItems}个项目有有效坐标`);
            } else {
                results.push(`⚠️ 坐标数据不完整：${validCoords}/${totalItems}个项目有有效坐标`);
            }

            resultsEl.innerHTML = results.map(result => `<div class="status ${result.startsWith('✅') ? 'success' : result.startsWith('❌') ? 'error' : 'warning'}">${result}</div>`).join('');
        }

        function initMap() {
            if (mapInstance) {
                mapInstance.remove();
            }

            mapInstance = L.map('mapContainer').setView([39.9042, 116.4074], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(mapInstance);

            // 创建图层组
            mapLayers.communities = L.layerGroup();
            mapLayers.organizations = L.layerGroup();
            mapLayers.elderly = L.layerGroup();
            mapLayers.alarms = L.layerGroup();

            // 添加标记
            addCommunityMarkers();
            addOrganizationMarkers();
            addElderlyMarkers();
            addAlarmMarkers();

            // 根据当前可见性设置添加图层
            Object.keys(layerVisibility).forEach(layerType => {
                if (layerVisibility[layerType]) {
                    mapInstance.addLayer(mapLayers[layerType]);
                }
            });
        }

        function addCommunityMarkers() {
            if (!mapData.communities) return;

            mapData.communities.forEach(community => {
                const iconColor = '#00d4ff';
                const iconHtml = '🏘️';

                const customIcon = L.divIcon({
                    html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([community.latitude, community.longitude], { icon: customIcon })
                    .bindPopup(`
                        <div style="color: #333; font-family: 'Microsoft YaHei';">
                            <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${community.name}</h4>
                            <p style="margin: 0; font-size: 12px;">类型: 社区</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">老人数量: ${community.elderlyCount}人</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">机构数量: ${community.facilityCount}个</p>
                        </div>
                    `);

                mapLayers.communities.addLayer(marker);
            });
        }

        function addOrganizationMarkers() {
            if (!mapData.organizations) return;

            mapData.organizations.forEach(org => {
                let iconColor = '#ff6b35';
                let iconHtml = '🏢';
                
                switch (org.type) {
                    case '机构养老单位（养老院）':
                        iconColor = '#ff6b35';
                        iconHtml = '🏥';
                        break;
                    case '社区养老单位（日照）':
                        iconColor = '#00d4ff';
                        iconHtml = '🏢';
                        break;
                    case '居家养老单位':
                        iconColor = '#2ed573';
                        iconHtml = '🏠';
                        break;
                }

                const customIcon = L.divIcon({
                    html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([org.latitude, org.longitude], { icon: customIcon })
                    .bindPopup(`
                        <div style="color: #333; font-family: 'Microsoft YaHei';">
                            <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${org.name}</h4>
                            <p style="margin: 0; font-size: 12px;">类型: ${org.type}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">床位数: ${org.bedCount}张</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">员工数: ${org.staffCount}人</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">服务数: ${org.serviceCount}项</p>
                        </div>
                    `);

                mapLayers.organizations.addLayer(marker);
            });
        }

        function addElderlyMarkers() {
            if (!mapData.elderly) return;

            mapData.elderly.forEach(elderly => {
                let iconColor = '#2ed573';
                let iconHtml = '👤';
                
                switch (elderly.elderlyType) {
                    case 'empty_nest':
                        iconColor = '#ff6b35';
                        iconHtml = '🏠';
                        break;
                    case 'living_alone':
                        iconColor = '#7b68ee';
                        iconHtml = '👤';
                        break;
                    case 'disabled':
                        iconColor = '#ff4757';
                        iconHtml = '♿';
                        break;
                    case 'elderly':
                        iconColor = '#ffa502';
                        iconHtml = '👴';
                        break;
                    case 'low_income':
                        iconColor = '#ff6348';
                        iconHtml = '💰';
                        break;
                    case 'special_care':
                        iconColor = '#ff9ff3';
                        iconHtml = '🏥';
                        break;
                }

                const customIcon = L.divIcon({
                    html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                    className: 'elderly-marker',
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                });

                const marker = L.marker([elderly.latitude, elderly.longitude], { icon: customIcon })
                    .bindPopup(`
                        <div style="color: #333; font-family: 'Microsoft YaHei';">
                            <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${elderly.elderlyName}</h4>
                            <p style="margin: 0; font-size: 12px;">社区: ${elderly.community}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">地址: ${elderly.address || '未填写'}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">年龄: ${elderly.age}岁</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">性别: ${elderly.gender}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">老人类型: ${getElderlyTypeLabel(elderly.elderlyType)}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">能力评估: ${elderly.abilityAssessment || '未评估'}</p>
                        </div>
                    `);

                mapLayers.elderly.addLayer(marker);
            });
        }

        function addAlarmMarkers() {
            if (!mapData.alarms) return;

            mapData.alarms.forEach(alarm => {
                let iconColor = '#ff4757';
                let iconHtml = '🚨';
                
                if (alarm.alarmType.includes('SOS') || alarm.alarmType.includes('紧急')) {
                    iconColor = '#ff4757';
                    iconHtml = '🆘';
                } else if (alarm.alarmType.includes('烟感') || alarm.alarmType.includes('火灾')) {
                    iconColor = '#ff6b35';
                    iconHtml = '🔥';
                } else if (alarm.alarmType.includes('跌倒')) {
                    iconColor = '#ffa502';
                    iconHtml = '⚠️';
                } else if (alarm.alarmType.includes('健康') || alarm.alarmType.includes('医疗')) {
                    iconColor = '#ff6348';
                    iconHtml = '💊';
                } else if (alarm.alarmType.includes('设备') || alarm.alarmType.includes('故障')) {
                    iconColor = '#ff9ff3';
                    iconHtml = '🔧';
                }

                const customIcon = L.divIcon({
                    html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: pulse 2s infinite;">${iconHtml}</div>`,
                    className: 'alarm-marker',
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                });

                const marker = L.marker([alarm.latitude, alarm.longitude], { icon: customIcon })
                    .bindPopup(`
                        <div style="color: #333; font-family: 'Microsoft YaHei';">
                            <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${alarm.alarmType}</h4>
                            <p style="margin: 0; font-size: 12px;">位置: ${alarm.location}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">时间: ${alarm.alarmTime}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">状态: ${alarm.processStatus}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">级别: ${alarm.alarmLevel}</p>
                        </div>
                    `);

                mapLayers.alarms.addLayer(marker);
            });
        }

        function getElderlyTypeLabel(type) {
            const typeMap = {
                'normal': '普通老人',
                'empty_nest': '空巢老人',
                'living_alone': '独居老人',
                'disabled': '失能老人',
                'elderly': '高龄老人',
                'low_income': '低收入老人',
                'special_care': '特殊照护'
            };
            return typeMap[type] || type || '未分类';
        }

        function toggleLayer(layerType) {
            if (!mapInstance || !mapLayers[layerType]) return;

            layerVisibility[layerType] = !layerVisibility[layerType];
            const btn = document.getElementById(layerType + 'Btn');
            
            if (layerVisibility[layerType]) {
                mapInstance.addLayer(mapLayers[layerType]);
                btn.classList.add('active');
            } else {
                mapInstance.removeLayer(mapLayers[layerType]);
                btn.classList.remove('active');
            }
        }

        function resetMapView() {
            if (mapInstance) {
                mapInstance.setView([39.9042, 116.4074], 11);
            }
        }

        function showAllLayers() {
            Object.keys(layerVisibility).forEach(layerType => {
                if (!layerVisibility[layerType]) {
                    toggleLayer(layerType);
                }
            });
        }

        function hideAllLayers() {
            Object.keys(layerVisibility).forEach(layerType => {
                if (layerVisibility[layerType]) {
                    toggleLayer(layerType);
                }
            });
        }

        function showRawData() {
            const dataEl = document.getElementById('rawData');
            if (dataEl.style.display === 'none') {
                dataEl.style.display = 'block';
                dataEl.textContent = JSON.stringify(mapData, null, 2);
            } else {
                dataEl.style.display = 'none';
            }
        }

        // 页面加载时自动开始
        window.onload = function() {
            setTimeout(loadMapData, 1000);
        };
    </script>

    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</body>
</html> 