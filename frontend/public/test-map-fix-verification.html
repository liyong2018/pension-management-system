<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°å›¾åŠŸèƒ½ä¿®å¤éªŒè¯</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .loading { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.active {
            background: #28a745;
        }
        .data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .map-container {
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card.blue { background: linear-gradient(135deg, #00d4ff 0%, #007bff 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); }
        .stat-card.green { background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%); }
        .stat-card.red { background: linear-gradient(135deg, #ff4757 0%, #dc3545 100%); }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .layer-btn {
            padding: 8px 16px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .layer-btn.active {
            background: #007bff;
            color: white;
        }
        .layer-btn:hover {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ åœ°å›¾åŠŸèƒ½ä¿®å¤éªŒè¯</h1>
        <p>éªŒè¯åœ°å€ï¼š<code>http://localhost:3004/test-map-fix-verification.html</code></p>
        
        <div class="card">
            <h2 class="title">1. ä¿®å¤ç»“æœæ¦‚è§ˆ</h2>
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-value" id="communityCount">-</div>
                    <div class="stat-label">ç¤¾åŒºæ•°é‡</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-value" id="organizationCount">-</div>
                    <div class="stat-label">æœºæ„æ•°é‡</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-value" id="elderlyCount">-</div>
                    <div class="stat-label">è€äººæ•°é‡</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-value" id="alarmCount">-</div>
                    <div class="stat-label">å‘Šè­¦æ•°é‡</div>
                </div>
            </div>
            <button class="btn" onclick="loadMapData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <div id="dataStatus" class="status loading">ç­‰å¾…åŠ è½½æ•°æ®...</div>
        </div>

        <div class="grid">
            <div class="card">
                <h2 class="title">2. åœ°å›¾å›¾å±‚æ§åˆ¶</h2>
                <div class="controls">
                    <button class="layer-btn active" id="communityBtn" onclick="toggleLayer('communities')">
                        ğŸ˜ï¸ ç¤¾åŒº (<span id="communityBtnCount">0</span>)
                    </button>
                    <button class="layer-btn active" id="organizationBtn" onclick="toggleLayer('organizations')">
                        ğŸ¢ æœºæ„ (<span id="organizationBtnCount">0</span>)
                    </button>
                    <button class="layer-btn" id="elderlyBtn" onclick="toggleLayer('elderly')">
                        ğŸ‘¥ è€äºº (<span id="elderlyBtnCount">0</span>)
                    </button>
                    <button class="layer-btn active" id="alarmBtn" onclick="toggleLayer('alarms')">
                        ğŸš¨ å‘Šè­¦ (<span id="alarmBtnCount">0</span>)
                    </button>
                </div>
                <button class="btn" onclick="resetMapView()">ğŸ¯ é‡ç½®è§†å›¾</button>
                <button class="btn" onclick="showAllLayers()">ğŸ‘ï¸ æ˜¾ç¤ºå…¨éƒ¨</button>
                <button class="btn" onclick="hideAllLayers()">ğŸ™ˆ éšè—å…¨éƒ¨</button>
            </div>

            <div class="card">
                <h2 class="title">3. æ•°æ®éªŒè¯ç»“æœ</h2>
                <div id="validationResults">
                    <div class="status loading">ç­‰å¾…éªŒè¯...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="title">4. äº¤äº’å¼åœ°å›¾</h2>
            <div id="mapContainer" class="map-container"></div>
        </div>

        <div class="card">
            <h2 class="title">5. åŸå§‹æ•°æ®æŸ¥çœ‹</h2>
            <button class="btn" onclick="showRawData()">ğŸ“‹ æŸ¥çœ‹åŸå§‹æ•°æ®</button>
            <div id="rawData" class="data" style="display: none;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let mapInstance = null;
        let mapData = null;
        let mapLayers = {
            communities: null,
            organizations: null,
            elderly: null,
            alarms: null
        };
        let layerVisibility = {
            communities: true,
            organizations: true,
            elderly: false,
            alarms: true
        };

        // APIåŸºç¡€URL
        const API_BASE = '/api';

        async function loadMapData() {
            const statusEl = document.getElementById('dataStatus');
            statusEl.className = 'status loading';
            statusEl.textContent = 'æ­£åœ¨åŠ è½½åœ°å›¾æ•°æ®...';

            try {
                const response = await fetch(`${API_BASE}/dashboard/stats`);
                const result = await response.json();

                if (result.success && result.data.mapData) {
                    mapData = result.data.mapData;
                    
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    updateStats();
                    
                    // éªŒè¯æ•°æ®
                    validateData();
                    
                    // åˆå§‹åŒ–åœ°å›¾
                    initMap();
                    
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… åœ°å›¾æ•°æ®åŠ è½½æˆåŠŸï¼';
                } else {
                    throw new Error('åœ°å›¾æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥: ' + error.message;
            }
        }

        function updateStats() {
            document.getElementById('communityCount').textContent = mapData.communities?.length || 0;
            document.getElementById('organizationCount').textContent = mapData.organizations?.length || 0;
            document.getElementById('elderlyCount').textContent = mapData.elderly?.length || 0;
            document.getElementById('alarmCount').textContent = mapData.alarms?.length || 0;
            
            // æ›´æ–°æŒ‰é’®è®¡æ•°
            document.getElementById('communityBtnCount').textContent = mapData.communities?.length || 0;
            document.getElementById('organizationBtnCount').textContent = mapData.organizations?.length || 0;
            document.getElementById('elderlyBtnCount').textContent = mapData.elderly?.length || 0;
            document.getElementById('alarmBtnCount').textContent = mapData.alarms?.length || 0;
        }

        function validateData() {
            const resultsEl = document.getElementById('validationResults');
            const results = [];

            // éªŒè¯ç¤¾åŒºæ•°æ®
            const communityCount = mapData.communities?.length || 0;
            if (communityCount >= 11) {
                results.push(`âœ… ç¤¾åŒºæ•°æ®æ­£ç¡®ï¼š${communityCount}ä¸ªç¤¾åŒºï¼ˆâ‰¥11ä¸ªï¼‰`);
            } else {
                results.push(`âŒ ç¤¾åŒºæ•°æ®ä¸è¶³ï¼š${communityCount}ä¸ªç¤¾åŒºï¼ˆåº”â‰¥11ä¸ªï¼‰`);
            }

            // éªŒè¯æœºæ„æ•°æ®
            const organizationCount = mapData.organizations?.length || 0;
            if (organizationCount >= 3) {
                results.push(`âœ… æœºæ„æ•°æ®æ­£ç¡®ï¼š${organizationCount}ä¸ªæœºæ„ï¼ˆâ‰¥3ä¸ªï¼‰`);
            } else {
                results.push(`âŒ æœºæ„æ•°æ®ä¸è¶³ï¼š${organizationCount}ä¸ªæœºæ„ï¼ˆåº”â‰¥3ä¸ªï¼‰`);
            }

            // éªŒè¯è€äººæ•°æ®
            const elderlyCount = mapData.elderly?.length || 0;
            if (elderlyCount > 0) {
                results.push(`âœ… è€äººæ•°æ®å­˜åœ¨ï¼š${elderlyCount}ä¸ªè€äººè®°å½•`);
            } else {
                results.push(`âš ï¸ è€äººæ•°æ®ä¸ºç©ºï¼š${elderlyCount}ä¸ªè€äººè®°å½•`);
            }

            // éªŒè¯å‘Šè­¦æ•°æ®
            const alarmCount = mapData.alarms?.length || 0;
            if (alarmCount > 0) {
                results.push(`âœ… å‘Šè­¦æ•°æ®å­˜åœ¨ï¼š${alarmCount}ä¸ªå‘Šè­¦è®°å½•`);
            } else {
                results.push(`âš ï¸ å‘Šè­¦æ•°æ®ä¸ºç©ºï¼š${alarmCount}ä¸ªå‘Šè­¦è®°å½•`);
            }

            // éªŒè¯åæ ‡æ•°æ®
            let validCoords = 0;
            let totalItems = 0;
            
            ['communities', 'organizations', 'elderly', 'alarms'].forEach(type => {
                if (mapData[type]) {
                    mapData[type].forEach(item => {
                        totalItems++;
                        if (item.longitude && item.latitude) {
                            validCoords++;
                        }
                    });
                }
            });

            if (validCoords === totalItems && totalItems > 0) {
                results.push(`âœ… åæ ‡æ•°æ®å®Œæ•´ï¼š${validCoords}/${totalItems}ä¸ªé¡¹ç›®æœ‰æœ‰æ•ˆåæ ‡`);
            } else {
                results.push(`âš ï¸ åæ ‡æ•°æ®ä¸å®Œæ•´ï¼š${validCoords}/${totalItems}ä¸ªé¡¹ç›®æœ‰æœ‰æ•ˆåæ ‡`);
            }

            resultsEl.innerHTML = results.map(result => `<div class="status ${result.startsWith('âœ…') ? 'success' : result.startsWith('âŒ') ? 'error' : 'warning'}">${result}</div>`).join('');
        }

        function initMap() {
            if (mapInstance) {
                mapInstance.remove();
            }

            mapInstance = L.map('mapContainer').setView([39.9042, 116.4074], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(mapInstance);

            // åˆ›å»ºå›¾å±‚ç»„
            mapLayers.communities = L.layerGroup();
            mapLayers.organizations = L.layerGroup();
            mapLayers.elderly = L.layerGroup();
            mapLayers.alarms = L.layerGroup();

            // æ·»åŠ æ ‡è®°
            addCommunityMarkers();
            addOrganizationMarkers();
            addElderlyMarkers();
            addAlarmMarkers();

            // æ ¹æ®å½“å‰å¯è§æ€§è®¾ç½®æ·»åŠ å›¾å±‚
            Object.keys(layerVisibility).forEach(layerType => {
                if (layerVisibility[layerType]) {
                    mapInstance.addLayer(mapLayers[layerType]);
                }
            });
        }

        function addCommunityMarkers() {
            if (!mapData.communities) return;

            mapData.communities.forEach(community => {
                const iconColor = '#00d4ff';
                const iconHtml = 'ğŸ˜ï¸';

                const customIcon = L.divIcon({
                    html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([community.latitude, community.longitude], { icon: customIcon })
                    .bindPopup(`
                        <div style="color: #333; font-family: 'Microsoft YaHei';">
                            <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${community.name}</h4>
                            <p style="margin: 0; font-size: 12px;">ç±»å‹: ç¤¾åŒº</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">è€äººæ•°é‡: ${community.elderlyCount}äºº</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">æœºæ„æ•°é‡: ${community.facilityCount}ä¸ª</p>
                        </div>
                    `);

                mapLayers.communities.addLayer(marker);
            });
        }

        function addOrganizationMarkers() {
            if (!mapData.organizations) return;

            mapData.organizations.forEach(org => {
                let iconColor = '#ff6b35';
                let iconHtml = 'ğŸ¢';
                
                switch (org.type) {
                    case 'æœºæ„å…»è€å•ä½ï¼ˆå…»è€é™¢ï¼‰':
                        iconColor = '#ff6b35';
                        iconHtml = 'ğŸ¥';
                        break;
                    case 'ç¤¾åŒºå…»è€å•ä½ï¼ˆæ—¥ç…§ï¼‰':
                        iconColor = '#00d4ff';
                        iconHtml = 'ğŸ¢';
                        break;
                    case 'å±…å®¶å…»è€å•ä½':
                        iconColor = '#2ed573';
                        iconHtml = 'ğŸ ';
                        break;
                }

                const customIcon = L.divIcon({
                    html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([org.latitude, org.longitude], { icon: customIcon })
                    .bindPopup(`
                        <div style="color: #333; font-family: 'Microsoft YaHei';">
                            <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${org.name}</h4>
                            <p style="margin: 0; font-size: 12px;">ç±»å‹: ${org.type}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">åºŠä½æ•°: ${org.bedCount}å¼ </p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">å‘˜å·¥æ•°: ${org.staffCount}äºº</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">æœåŠ¡æ•°: ${org.serviceCount}é¡¹</p>
                        </div>
                    `);

                mapLayers.organizations.addLayer(marker);
            });
        }

        function addElderlyMarkers() {
            if (!mapData.elderly) return;

            mapData.elderly.forEach(elderly => {
                let iconColor = '#2ed573';
                let iconHtml = 'ğŸ‘¤';
                
                switch (elderly.elderlyType) {
                    case 'empty_nest':
                        iconColor = '#ff6b35';
                        iconHtml = 'ğŸ ';
                        break;
                    case 'living_alone':
                        iconColor = '#7b68ee';
                        iconHtml = 'ğŸ‘¤';
                        break;
                    case 'disabled':
                        iconColor = '#ff4757';
                        iconHtml = 'â™¿';
                        break;
                    case 'elderly':
                        iconColor = '#ffa502';
                        iconHtml = 'ğŸ‘´';
                        break;
                    case 'low_income':
                        iconColor = '#ff6348';
                        iconHtml = 'ğŸ’°';
                        break;
                    case 'special_care':
                        iconColor = '#ff9ff3';
                        iconHtml = 'ğŸ¥';
                        break;
                }

                const customIcon = L.divIcon({
                    html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                    className: 'elderly-marker',
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                });

                const marker = L.marker([elderly.latitude, elderly.longitude], { icon: customIcon })
                    .bindPopup(`
                        <div style="color: #333; font-family: 'Microsoft YaHei';">
                            <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${elderly.elderlyName}</h4>
                            <p style="margin: 0; font-size: 12px;">ç¤¾åŒº: ${elderly.community}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">åœ°å€: ${elderly.address || 'æœªå¡«å†™'}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">å¹´é¾„: ${elderly.age}å²</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">æ€§åˆ«: ${elderly.gender}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">è€äººç±»å‹: ${getElderlyTypeLabel(elderly.elderlyType)}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">èƒ½åŠ›è¯„ä¼°: ${elderly.abilityAssessment || 'æœªè¯„ä¼°'}</p>
                        </div>
                    `);

                mapLayers.elderly.addLayer(marker);
            });
        }

        function addAlarmMarkers() {
            if (!mapData.alarms) return;

            mapData.alarms.forEach(alarm => {
                let iconColor = '#ff4757';
                let iconHtml = 'ğŸš¨';
                
                if (alarm.alarmType.includes('SOS') || alarm.alarmType.includes('ç´§æ€¥')) {
                    iconColor = '#ff4757';
                    iconHtml = 'ğŸ†˜';
                } else if (alarm.alarmType.includes('çƒŸæ„Ÿ') || alarm.alarmType.includes('ç«ç¾')) {
                    iconColor = '#ff6b35';
                    iconHtml = 'ğŸ”¥';
                } else if (alarm.alarmType.includes('è·Œå€’')) {
                    iconColor = '#ffa502';
                    iconHtml = 'âš ï¸';
                } else if (alarm.alarmType.includes('å¥åº·') || alarm.alarmType.includes('åŒ»ç–—')) {
                    iconColor = '#ff6348';
                    iconHtml = 'ğŸ’Š';
                } else if (alarm.alarmType.includes('è®¾å¤‡') || alarm.alarmType.includes('æ•…éšœ')) {
                    iconColor = '#ff9ff3';
                    iconHtml = 'ğŸ”§';
                }

                const customIcon = L.divIcon({
                    html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: pulse 2s infinite;">${iconHtml}</div>`,
                    className: 'alarm-marker',
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                });

                const marker = L.marker([alarm.latitude, alarm.longitude], { icon: customIcon })
                    .bindPopup(`
                        <div style="color: #333; font-family: 'Microsoft YaHei';">
                            <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${alarm.alarmType}</h4>
                            <p style="margin: 0; font-size: 12px;">ä½ç½®: ${alarm.location}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">æ—¶é—´: ${alarm.alarmTime}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">çŠ¶æ€: ${alarm.processStatus}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px;">çº§åˆ«: ${alarm.alarmLevel}</p>
                        </div>
                    `);

                mapLayers.alarms.addLayer(marker);
            });
        }

        function getElderlyTypeLabel(type) {
            const typeMap = {
                'normal': 'æ™®é€šè€äºº',
                'empty_nest': 'ç©ºå·¢è€äºº',
                'living_alone': 'ç‹¬å±…è€äºº',
                'disabled': 'å¤±èƒ½è€äºº',
                'elderly': 'é«˜é¾„è€äºº',
                'low_income': 'ä½æ”¶å…¥è€äºº',
                'special_care': 'ç‰¹æ®Šç…§æŠ¤'
            };
            return typeMap[type] || type || 'æœªåˆ†ç±»';
        }

        function toggleLayer(layerType) {
            if (!mapInstance || !mapLayers[layerType]) return;

            layerVisibility[layerType] = !layerVisibility[layerType];
            const btn = document.getElementById(layerType + 'Btn');
            
            if (layerVisibility[layerType]) {
                mapInstance.addLayer(mapLayers[layerType]);
                btn.classList.add('active');
            } else {
                mapInstance.removeLayer(mapLayers[layerType]);
                btn.classList.remove('active');
            }
        }

        function resetMapView() {
            if (mapInstance) {
                mapInstance.setView([39.9042, 116.4074], 11);
            }
        }

        function showAllLayers() {
            Object.keys(layerVisibility).forEach(layerType => {
                if (!layerVisibility[layerType]) {
                    toggleLayer(layerType);
                }
            });
        }

        function hideAllLayers() {
            Object.keys(layerVisibility).forEach(layerType => {
                if (layerVisibility[layerType]) {
                    toggleLayer(layerType);
                }
            });
        }

        function showRawData() {
            const dataEl = document.getElementById('rawData');
            if (dataEl.style.display === 'none') {
                dataEl.style.display = 'block';
                dataEl.textContent = JSON.stringify(mapData, null, 2);
            } else {
                dataEl.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹
        window.onload = function() {
            setTimeout(loadMapData, 1000);
        };
    </script>

    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</body>
</html> 