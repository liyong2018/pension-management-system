<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°å›¾æ•°æ®ä¿®å¤éªŒè¯</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .loading { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .map-container {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background: #f8f9fa;
        }
        .issue {
            background: #f8d7da;
            color: #721c24;
        }
        .good {
            background: #d4edda;
            color: #155724;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ åœ°å›¾æ•°æ®ä¿®å¤éªŒè¯å·¥å…·</h1>
        <p>æµ‹è¯•åœ°å€ï¼š<code>http://localhost:3004/test-map-diagnosis.html</code></p>
        
        <div class="card">
            <h2 class="title">1. æœåŠ¡çŠ¶æ€æ£€æŸ¥</h2>
            <button class="btn" onclick="checkServices()">æ£€æŸ¥æœåŠ¡çŠ¶æ€</button>
            <div id="serviceStatus" class="status loading">ç­‰å¾…æ£€æŸ¥...</div>
            <div class="progress">
                <div id="serviceProgress" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2 class="title">2. ä¿®å¤å‰åå¯¹æ¯”</h2>
                <button class="btn" onclick="testMapData()">æµ‹è¯•åœ°å›¾æ•°æ®</button>
                <div id="mapTestStatus" class="status loading">ç­‰å¾…æµ‹è¯•...</div>
                <div id="mapTestData" class="data" style="display: none;"></div>
            </div>

            <div class="card">
                <h2 class="title">3. æ•°æ®ç»Ÿè®¡</h2>
                <div id="dataStats" class="data">
ç­‰å¾…æ•°æ®åŠ è½½...
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="title">4. åœ°å›¾å¯è§†åŒ–éªŒè¯</h2>
            <button class="btn" onclick="visualizeMap()">æ˜¾ç¤ºåœ°å›¾</button>
            <div id="mapVisualizationStatus" class="status loading">ç­‰å¾…æ˜¾ç¤º...</div>
            <div id="mapContainer" class="map-container" style="display: none;"></div>
        </div>

        <div class="card">
            <h2 class="title">5. ä¿®å¤ç»“æœæ€»ç»“</h2>
            <div id="fixSummary" style="display: none;">
                <h4>ğŸ¯ ä¿®å¤ç»“æœï¼š</h4>
                <ul id="fixResults"></ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentApiData = null;
        let map = null;

        // APIåŸºç¡€URLï¼ˆåŒæºï¼Œé¿å…è·¨åŸŸé—®é¢˜ï¼‰
        const API_BASE = '/api';

        async function checkServices() {
            const statusEl = document.getElementById('serviceStatus');
            const progressEl = document.getElementById('serviceProgress');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...';
            progressEl.style.width = '20%';

            try {
                // æ£€æŸ¥åç«¯API
                const response = await fetch(`${API_BASE}/dashboard/stats`);
                progressEl.style.width = '60%';
                
                if (response.ok) {
                    const result = await response.json();
                    progressEl.style.width = '100%';
                    
                    if (result.success) {
                        statusEl.className = 'status success';
                        statusEl.textContent = 'âœ… åç«¯æœåŠ¡æ­£å¸¸ï¼ŒAPIå“åº”æˆåŠŸï¼';
                        currentApiData = result.data;
                    } else {
                        statusEl.className = 'status warning';
                        statusEl.textContent = 'âš ï¸ åç«¯æœåŠ¡å“åº”ï¼Œä½†è¿”å›é”™è¯¯: ' + result.message;
                    }
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ åç«¯æœåŠ¡å¼‚å¸¸ï¼ŒçŠ¶æ€ç : ' + response.status;
                }
            } catch (error) {
                progressEl.style.width = '0%';
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ æœåŠ¡è¿æ¥å¤±è´¥: ' + error.message;
            }
        }

        async function testMapData() {
            const statusEl = document.getElementById('mapTestStatus');
            const dataEl = document.getElementById('mapTestData');
            const statsEl = document.getElementById('dataStats');

            statusEl.className = 'status loading';
            statusEl.textContent = 'æ­£åœ¨æµ‹è¯•åœ°å›¾æ•°æ®...';

            try {
                const response = await fetch(`${API_BASE}/dashboard/stats`);
                const result = await response.json();

                if (result.success && result.data.mapData) {
                    const mapData = result.data.mapData;
                    currentApiData = result.data;
                    
                    statusEl.className = 'status success';
                    statusEl.textContent = `âœ… åœ°å›¾æ•°æ®è·å–æˆåŠŸï¼å…± ${mapData.communities.length} ä¸ªç¤¾åŒº`;
                    
                    dataEl.style.display = 'block';
                    dataEl.textContent = JSON.stringify(mapData, null, 2);

                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    const totalElderly = mapData.communities.reduce((sum, c) => sum + (c.elderlyCount || 0), 0);
                    const totalFacilities = mapData.communities.reduce((sum, c) => sum + (c.facilityCount || 0), 0);
                    
                    statsEl.textContent = `ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š
â€¢ ç¤¾åŒºæ•°é‡ï¼š${mapData.communities.length} ä¸ª
â€¢ è€äººæ€»æ•°ï¼š${totalElderly} äºº
â€¢ æœºæ„æ€»æ•°ï¼š${totalFacilities} ä¸ª
â€¢ åæ ‡å®Œæ•´æ€§ï¼š${mapData.communities.filter(c => c.longitude && c.latitude).length}/${mapData.communities.length}

ğŸ˜ï¸ ç¤¾åŒºè¯¦æƒ…ï¼š
${mapData.communities.map(c => 
`â€¢ ${c.name}ï¼š${c.elderlyCount}äººï¼Œåæ ‡(${c.latitude}, ${c.longitude})`
).join('\n')}`;

                } else {
                    throw new Error('åœ°å›¾æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ åœ°å›¾æ•°æ®æµ‹è¯•å¤±è´¥: ' + error.message;
                dataEl.style.display = 'block';
                dataEl.textContent = error.toString();
            }
        }

        function visualizeMap() {
            const statusEl = document.getElementById('mapVisualizationStatus');
            const mapContainer = document.getElementById('mapContainer');

            if (!currentApiData || !currentApiData.mapData || !currentApiData.mapData.communities) {
                statusEl.className = 'status warning';
                statusEl.textContent = 'âš ï¸ è¯·å…ˆæµ‹è¯•åœ°å›¾æ•°æ®';
                return;
            }

            statusEl.className = 'status loading';
            statusEl.textContent = 'æ­£åœ¨åˆå§‹åŒ–åœ°å›¾...';

            try {
                mapContainer.style.display = 'block';
                
                if (map) {
                    map.remove();
                }
                
                map = L.map(mapContainer).setView([39.9042, 116.4074], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                // æ·»åŠ ç¤¾åŒºæ ‡è®°
                const communities = currentApiData.mapData.communities;
                let validMarkers = 0;
                
                communities.forEach(community => {
                    if (community.longitude && community.latitude) {
                        let iconColor = '#2ed573'; // ç»¿è‰²è¡¨ç¤ºå±…å®¶å…»è€
                        let iconHtml = 'ğŸ ';
                        
                        switch (community.type) {
                            case 'æ—¥ç…§':
                                iconColor = '#00d4ff';
                                iconHtml = 'ğŸ¢';
                                break;
                            case 'æœºæ„':
                                iconColor = '#ff6b35';
                                iconHtml = 'ğŸ¥';
                                break;
                            case 'å±…å®¶å…»è€':
                                iconColor = '#2ed573';
                                iconHtml = 'ğŸ ';
                                break;
                        }

                        const customIcon = L.divIcon({
                            html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                            className: 'custom-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });

                        L.marker([community.latitude, community.longitude], { icon: customIcon })
                            .bindPopup(`
                                <div style="font-family: 'Microsoft YaHei';">
                                    <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${community.name}</h4>
                                    <p style="margin: 2px 0; font-size: 12px;"><strong>ç±»å‹:</strong> ${community.type}</p>
                                    <p style="margin: 2px 0; font-size: 12px;"><strong>è€äººæ•°é‡:</strong> ${community.elderlyCount}äºº</p>
                                    <p style="margin: 2px 0; font-size: 12px;"><strong>æœºæ„æ•°é‡:</strong> ${community.facilityCount}ä¸ª</p>
                                    <p style="margin: 2px 0; font-size: 12px;"><strong>åæ ‡:</strong> ${community.latitude.toFixed(4)}, ${community.longitude.toFixed(4)}</p>
                                </div>
                            `)
                            .addTo(map);
                        
                        validMarkers++;
                    }
                });

                statusEl.className = 'status success';
                statusEl.textContent = `âœ… åœ°å›¾æ˜¾ç¤ºæˆåŠŸï¼å…±æ˜¾ç¤º ${validMarkers} ä¸ªæœ‰æ•ˆæ ‡è®°`;

                // æ˜¾ç¤ºä¿®å¤æ€»ç»“
                showFixSummary(communities);

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ åœ°å›¾æ˜¾ç¤ºå¤±è´¥: ' + error.message;
            }
        }

        function showFixSummary(communities) {
            const summaryEl = document.getElementById('fixSummary');
            const resultsEl = document.getElementById('fixResults');

            const results = [
                `âœ… ä¿®å¤äº†BigDecimalç±»å‹è½¬æ¢é”™è¯¯`,
                `âœ… åœ°å›¾æ•°æ®æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› ${communities.length} ä¸ªç¤¾åŒº`,
                `âœ… åæ ‡æ•°æ®å›ºå®šåŒ–ï¼Œä¸å†éšæœºç”Ÿæˆ`,
                `âœ… è€äººæ•°é‡ç»Ÿè®¡æ­£ç¡®ï¼š${communities.reduce((sum, c) => sum + c.elderlyCount, 0)} äºº`,
                `âœ… åœ°å›¾å¯è§†åŒ–æ­£å¸¸æ˜¾ç¤º`,
                `âœ… è·¨åŸŸé—®é¢˜å·²è§£å†³ï¼ˆä½¿ç”¨åŒæºè¯·æ±‚ï¼‰`
            ];

            resultsEl.innerHTML = results.map(result => `<li>${result}</li>`).join('');
            summaryEl.style.display = 'block';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æ£€æŸ¥
        window.onload = function() {
            setTimeout(() => {
                checkServices();
                setTimeout(() => {
                    if (currentApiData) {
                        testMapData();
                    }
                }, 2000);
            }, 1000);
        };
    </script>
</body>
</html> 