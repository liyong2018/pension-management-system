<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图数据修复验证</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .loading { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .map-container {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background: #f8f9fa;
        }
        .issue {
            background: #f8d7da;
            color: #721c24;
        }
        .good {
            background: #d4edda;
            color: #155724;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗺️ 地图数据修复验证工具</h1>
        <p>测试地址：<code>http://localhost:3004/test-map-diagnosis.html</code></p>
        
        <div class="card">
            <h2 class="title">1. 服务状态检查</h2>
            <button class="btn" onclick="checkServices()">检查服务状态</button>
            <div id="serviceStatus" class="status loading">等待检查...</div>
            <div class="progress">
                <div id="serviceProgress" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2 class="title">2. 修复前后对比</h2>
                <button class="btn" onclick="testMapData()">测试地图数据</button>
                <div id="mapTestStatus" class="status loading">等待测试...</div>
                <div id="mapTestData" class="data" style="display: none;"></div>
            </div>

            <div class="card">
                <h2 class="title">3. 数据统计</h2>
                <div id="dataStats" class="data">
等待数据加载...
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="title">4. 地图可视化验证</h2>
            <button class="btn" onclick="visualizeMap()">显示地图</button>
            <div id="mapVisualizationStatus" class="status loading">等待显示...</div>
            <div id="mapContainer" class="map-container" style="display: none;"></div>
        </div>

        <div class="card">
            <h2 class="title">5. 修复结果总结</h2>
            <div id="fixSummary" style="display: none;">
                <h4>🎯 修复结果：</h4>
                <ul id="fixResults"></ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentApiData = null;
        let map = null;

        // API基础URL（同源，避免跨域问题）
        const API_BASE = '/api';

        async function checkServices() {
            const statusEl = document.getElementById('serviceStatus');
            const progressEl = document.getElementById('serviceProgress');
            
            statusEl.className = 'status loading';
            statusEl.textContent = '正在检查服务状态...';
            progressEl.style.width = '20%';

            try {
                // 检查后端API
                const response = await fetch(`${API_BASE}/dashboard/stats`);
                progressEl.style.width = '60%';
                
                if (response.ok) {
                    const result = await response.json();
                    progressEl.style.width = '100%';
                    
                    if (result.success) {
                        statusEl.className = 'status success';
                        statusEl.textContent = '✅ 后端服务正常，API响应成功！';
                        currentApiData = result.data;
                    } else {
                        statusEl.className = 'status warning';
                        statusEl.textContent = '⚠️ 后端服务响应，但返回错误: ' + result.message;
                    }
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = '❌ 后端服务异常，状态码: ' + response.status;
                }
            } catch (error) {
                progressEl.style.width = '0%';
                statusEl.className = 'status error';
                statusEl.textContent = '❌ 服务连接失败: ' + error.message;
            }
        }

        async function testMapData() {
            const statusEl = document.getElementById('mapTestStatus');
            const dataEl = document.getElementById('mapTestData');
            const statsEl = document.getElementById('dataStats');

            statusEl.className = 'status loading';
            statusEl.textContent = '正在测试地图数据...';

            try {
                const response = await fetch(`${API_BASE}/dashboard/stats`);
                const result = await response.json();

                if (result.success && result.data.mapData) {
                    const mapData = result.data.mapData;
                    currentApiData = result.data;
                    
                    statusEl.className = 'status success';
                    statusEl.textContent = `✅ 地图数据获取成功！共 ${mapData.communities.length} 个社区`;
                    
                    dataEl.style.display = 'block';
                    dataEl.textContent = JSON.stringify(mapData, null, 2);

                    // 更新统计信息
                    const totalElderly = mapData.communities.reduce((sum, c) => sum + (c.elderlyCount || 0), 0);
                    const totalFacilities = mapData.communities.reduce((sum, c) => sum + (c.facilityCount || 0), 0);
                    
                    statsEl.textContent = `📊 数据统计：
• 社区数量：${mapData.communities.length} 个
• 老人总数：${totalElderly} 人
• 机构总数：${totalFacilities} 个
• 坐标完整性：${mapData.communities.filter(c => c.longitude && c.latitude).length}/${mapData.communities.length}

🏘️ 社区详情：
${mapData.communities.map(c => 
`• ${c.name}：${c.elderlyCount}人，坐标(${c.latitude}, ${c.longitude})`
).join('\n')}`;

                } else {
                    throw new Error('地图数据为空或格式错误');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '❌ 地图数据测试失败: ' + error.message;
                dataEl.style.display = 'block';
                dataEl.textContent = error.toString();
            }
        }

        function visualizeMap() {
            const statusEl = document.getElementById('mapVisualizationStatus');
            const mapContainer = document.getElementById('mapContainer');

            if (!currentApiData || !currentApiData.mapData || !currentApiData.mapData.communities) {
                statusEl.className = 'status warning';
                statusEl.textContent = '⚠️ 请先测试地图数据';
                return;
            }

            statusEl.className = 'status loading';
            statusEl.textContent = '正在初始化地图...';

            try {
                mapContainer.style.display = 'block';
                
                if (map) {
                    map.remove();
                }
                
                map = L.map(mapContainer).setView([39.9042, 116.4074], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // 添加社区标记
                const communities = currentApiData.mapData.communities;
                let validMarkers = 0;
                
                communities.forEach(community => {
                    if (community.longitude && community.latitude) {
                        let iconColor = '#2ed573'; // 绿色表示居家养老
                        let iconHtml = '🏠';
                        
                        switch (community.type) {
                            case '日照':
                                iconColor = '#00d4ff';
                                iconHtml = '🏢';
                                break;
                            case '机构':
                                iconColor = '#ff6b35';
                                iconHtml = '🏥';
                                break;
                            case '居家养老':
                                iconColor = '#2ed573';
                                iconHtml = '🏠';
                                break;
                        }

                        const customIcon = L.divIcon({
                            html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${iconHtml}</div>`,
                            className: 'custom-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });

                        L.marker([community.latitude, community.longitude], { icon: customIcon })
                            .bindPopup(`
                                <div style="font-family: 'Microsoft YaHei';">
                                    <h4 style="margin: 0 0 8px 0; color: ${iconColor};">${community.name}</h4>
                                    <p style="margin: 2px 0; font-size: 12px;"><strong>类型:</strong> ${community.type}</p>
                                    <p style="margin: 2px 0; font-size: 12px;"><strong>老人数量:</strong> ${community.elderlyCount}人</p>
                                    <p style="margin: 2px 0; font-size: 12px;"><strong>机构数量:</strong> ${community.facilityCount}个</p>
                                    <p style="margin: 2px 0; font-size: 12px;"><strong>坐标:</strong> ${community.latitude.toFixed(4)}, ${community.longitude.toFixed(4)}</p>
                                </div>
                            `)
                            .addTo(map);
                        
                        validMarkers++;
                    }
                });

                statusEl.className = 'status success';
                statusEl.textContent = `✅ 地图显示成功！共显示 ${validMarkers} 个有效标记`;

                // 显示修复总结
                showFixSummary(communities);

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '❌ 地图显示失败: ' + error.message;
            }
        }

        function showFixSummary(communities) {
            const summaryEl = document.getElementById('fixSummary');
            const resultsEl = document.getElementById('fixResults');

            const results = [
                `✅ 修复了BigDecimal类型转换错误`,
                `✅ 地图数据查询成功，返回 ${communities.length} 个社区`,
                `✅ 坐标数据固定化，不再随机生成`,
                `✅ 老人数量统计正确：${communities.reduce((sum, c) => sum + c.elderlyCount, 0)} 人`,
                `✅ 地图可视化正常显示`,
                `✅ 跨域问题已解决（使用同源请求）`
            ];

            resultsEl.innerHTML = results.map(result => `<li>${result}</li>`).join('');
            summaryEl.style.display = 'block';
        }

        // 页面加载时自动开始检查
        window.onload = function() {
            setTimeout(() => {
                checkServices();
                setTimeout(() => {
                    if (currentApiData) {
                        testMapData();
                    }
                }, 2000);
            }, 1000);
        };
    </script>
</body>
</html> 